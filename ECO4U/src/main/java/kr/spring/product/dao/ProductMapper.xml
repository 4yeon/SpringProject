<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="kr.spring.product.dao.ProductMapper">
	<select id="selectRowCount" parameterType="map" resultType="integer">
		SELECT
		 COUNT(*)
		FROM product
		<where>
			<if test="keyword != null and keyword != ''">
				<if test="keyfield == 1">
					p_name LIKE '%' || #{keyword} || '%'
				</if>
				<if test="keyfield == 2">
					p_brand LIKE '%' || #{keyword} || '%'
				</if>
			</if>
		</where>
	</select>
	<select id="selectList" parameterType="map" resultType="kr.spring.product.vo.ProductVO">
		SELECT
  		   *
  		FROM (SELECT
  		        a.*,
  		        rownum rnum
  		      FROM (SELECT
  		              p_num,
					  p_name,
					  p_price,
					  p_dprice,
					  p_quantity,
					  p_brand,
					  p_photoname,
					  reg_date,
					  modify_date
					  ROW_NUMBER() OVER(
					  <include refid="sort"/> AS rnum
		            FROM product
					<where>
						<if test="keyword != null and keyword != ''">
							<if test="keyfield == 1">
							p_name LIKE '%' || #{keyword} || '%'
							</if>
							<if test="keyfield == 2">
							p_brand LIKE '%' || #{keyword} || '%'
							</if>
						</if>
					</where>
					<include refid="sort"/>
		<![CDATA[
  		WHERE rnum >= #{start} AND rnum <= #{end}
  		]]>
	</select>
	<sql id="sort">
		<if test="sort==null">
		ORDER BY p_num DESC
		</if>
		<if test="sort==p_num">
		ORDER BY p_num DESC
		</if>
		
		<if test="sort==rowprice">
		ORDER BY p_price ASC
		</if>
		<if test="sort==highprice">
		ORDER BY p_price DESC
		</if>
	</sql>
	
	<!--상품 수정-->
	<update id="updateProduct" parameterType="kr.spring.product.vo.ProductVO">
		UPDATE product SET
			<if test="p_photoname != ''">
			p_photo=#{p_photo},
			p_photoname=#{p_photoname},
			</if>
			p_name=#{p_name},
			p_cont1=#{p_cont1},
			p_cont2=#{p_cont2},
			p_brand=#{p_brand},
			p_price=#{p_price},
			p_dprice=#{p_dprice},
			p_quantity=#{p_quantity},
			p_status=#{p_status},
			p_category=#{p_category},
			modify_date=SYSDATE
		WHERE p_num=#{p_num}
	</update>
	
	<!--리뷰 목록-->
	<select id="selectListReview" parameterType="map" resultType="kr.spring.product.vo.P_reviewVO">
		SELECT
		 *
		FROM (SELECT
			  a.*,
			  rownum rnum
			FROM (SELECT
				  r_num,
				  <![CDATA[
  		          REPLACE(REPLACE(r_title,'<','&lt;'),'>','&gt;') r_title,
  		          ]]>
				  <![CDATA[
  		          REPLACE(REPLACE(r_content,'<','&lt;'),'>','&gt;') r_content,
  		          ]]>
				  r_photoname,
				  reg_date,
				  modify_date,
				  p_num,
				  mem_num
				FROM p_review
				JOIN member USING(mem_num)
				WHERE p_num = #{p_num}
				ORDER BY r_num DESC)a)
		<![CDATA[
  		WHERE rnum >= #{start} AND rnum <= #{end}
  		]]>
	</select>
	
</mapper>